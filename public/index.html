<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Web Obfuscator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, sans-serif; background:#0b1220; color:#e6eef8; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
    .card { background:linear-gradient(180deg,#071021 0%, #092033 100%); padding:24px; border-radius:12px; width:420px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    h1 { margin:0 0 12px 0; font-size:20px; }
    label { display:block; margin-top:10px; font-size:13px; color:#bcd0ee; }
    input[type=file] { margin-top:6px; color:#fff; }
    select, input[type=text], button { width:100%; margin-top:8px; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:#eaf4ff; }
    .progress { margin-top:12px; height:12px; background:#071422; border-radius:8px; overflow:hidden; }
    .bar { height:100%; width:0%; background:linear-gradient(90deg,#1e90ff,#4ad0ff); transition:width 300ms ease; }
    .status { margin-top:8px; font-size:13px; color:#9fb8d8; }
    .download { margin-top:12px; text-align:center; }
    a.btn { display:inline-block; padding:8px 12px; border-radius:8px; background:#1e90ff; color:#002233; text-decoration:none; font-weight:600; }
    small.hint { color:#7da2c9; display:block; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>JS Obfuscator — Web</h1>
    <label>File .js (upload)</label>
    <input id="file" type="file" accept=".js" />

    <label>Preset</label>
    <select id="preset">
      <option value="ultra">Ultra Enc (default)</option>
      <option value="nova">Nova Enc</option>
      <option value="nebula">Nebula Enc</option>
      <option value="arab">Arab Enc Style</option>
      <option value="japan">Japan Enc Style</option>
      <option value="xa">Arab x Japan</option>
    </select>

    <label>Password (opsional) — jika diisi akan membungkus kode dengan password prompt</label>
    <input id="password" type="text" placeholder="Masukkan password (optional)" />

    <button id="uploadBtn">Upload & Start Obfuscation</button>

    <div class="progress" style="display:none;">
      <div class="bar" id="bar"></div>
    </div>
    <div class="status" id="status"></div>

    <div class="download" id="downloadArea"></div>

    <small class="hint">Jalankan lokal untuk keamanan. Jangan upload kode sensitif ke server publik.</small>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("file");
const presetEl = document.getElementById("preset");
const pwdEl = document.getElementById("password");
const bar = document.getElementById("bar");
const status = document.getElementById("status");
const progressWrapper = document.querySelector(".progress");
const downloadArea = document.getElementById("downloadArea");

function setProgress(p) {
  progressWrapper.style.display = "block";
  bar.style.width = p + "%";
}

uploadBtn.addEventListener("click", async () => {
  const f = fileInput.files[0];
  if (!f) return alert("Pilih file .js dulu");
  const form = new FormData();
  form.append("file", f);

  uploadBtn.disabled = true;
  status.textContent = "Mengunggah file...";
  setProgress(3);

  const resp = await fetch("/upload", { method: "POST", body: form });
  const json = await resp.json();
  if (!json.ok) {
    alert("Upload gagal");
    uploadBtn.disabled = false;
    return;
  }

  setProgress(10);
  status.textContent = "Upload selesai. Memulai obfuscation...";

  // kirim event start ke socket
  socket.emit("start", { file: json.filename, preset: presetEl.value, password: pwdEl.value || "" });
});

socket.on("progress", (data) => {
  if (data.percent) setProgress(data.percent);
  if (data.status) status.textContent = data.status;
  if (data.download) {
    downloadArea.innerHTML = `<a class="btn" href="${data.download}" target="_blank" rel="noopener">⬇️ Download hasil</a>`;
  }
});

socket.on("done", (data) => {
  status.textContent = "Selesai! Klik tombol download di bawah.";
  uploadBtn.disabled = false;
  if (data && data.download) {
    downloadArea.innerHTML = `<a class="btn" href="${data.download}" target="_blank" rel="noopener">⬇️ Download ${data.filename}</a>`;
  }
});

socket.on("error", (err) => {
  status.textContent = "Error: " + (err.message || err);
  uploadBtn.disabled = false;
});

socket.on("connect", () => {
  console.log("socket connected");
});
</script>
</body>
</html>
